using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

/*=================================================================================================
DESCRIPTION
*================================================================================================*/
/* 
 ------------------------------------------------------------------------------------------------*/

namespace PasswordVault
{
    /*=================================================================================================
	ENUMERATIONS
	*================================================================================================*/

    /*=================================================================================================
	STRUCTS
	*================================================================================================*/

    /*=================================================================================================
	CLASSES
	*================================================================================================*/
    class CSVPasswordManager : ICSVPasswordManager
    {
        /*=================================================================================================
		CONSTANTS
		*================================================================================================*/
        /*PUBLIC******************************************************************************************/

        /*PRIVATE*****************************************************************************************/
        private const int _ID_IDX = 0;
        private const int _APP_IDX = 1;
        private const int _USER_IDX = 2;
        private const int _DESC_IDX = 3;
        private const int _WEB_IDX = 4;
        private const int _PASS_IDX = 5;
        private const int _NUM_FIELDS = 6;

        /*=================================================================================================
		FIELDS
		*================================================================================================*/
        /*PUBLIC******************************************************************************************/

        /*PRIVATE*****************************************************************************************/
        private ICSVReader _reader;
        private ICSVWriter _writer;
        private List<DatabasePassword> _encryptedPasswordList;

        /*=================================================================================================
		PROPERTIES
		*================================================================================================*/
        /*PUBLIC******************************************************************************************/

        /*PRIVATE*****************************************************************************************/

        /*=================================================================================================
		CONSTRUCTORS
		*================================================================================================*/
        public CSVPasswordManager(ICSVReader reader, ICSVWriter writer)
        {
            _reader = reader;
            _writer = writer;
            _encryptedPasswordList = new List<DatabasePassword>();
        }

        /*=================================================================================================
		PUBLIC METHODS
		*================================================================================================*/
        /*************************************************************************************************/
        public List<DatabasePassword> GetEncryptedPasswords()
        {
            return _encryptedPasswordList;
        }

        /*************************************************************************************************/
        public void ParsePasswordCSVFile(string fileName)
        {
            string line;
            _reader.Initialize(fileName);

            line = _reader.ReadLine();

            while (ValidLine(line))
            {
                _encryptedPasswordList.Add(ParseLine(line));
                line = _reader.ReadLine();
            }

            _reader.Close();
        }

        /*************************************************************************************************/
        public void UpdatePasswordCSVFile(string filename, List<DatabasePassword> encryptedPasswords)
        {
            _writer.Initialize(filename);

            foreach (var password in encryptedPasswords)
            {
                _writer.WriteLine(password.GetPasswordString());
            }

            _writer.Close();
        }

        /*=================================================================================================
		PRIVATE METHODS
		*================================================================================================*/
        /*************************************************************************************************/
        /*************************************************************************************************/
        private DatabasePassword ParseLine(string line)
        {
            DatabasePassword pass = null;

            string[] fields = line.Split(',');

            if (fields.Count() == _NUM_FIELDS)
            {
                pass = new DatabasePassword(fields[_ID_IDX], fields[_APP_IDX], fields[_USER_IDX], fields[_DESC_IDX], fields[_WEB_IDX], fields[_PASS_IDX]);
            }

            return pass;
        }

        /*************************************************************************************************/
        private bool ValidLine(string line)
        {
            bool result = false;

            if (line == null)
            {
                result = false;
            }
            else if (line.Split(',').Count() == _NUM_FIELDS)
            {
                result = true;
            }

            return result;
        }

        /*=================================================================================================
		STATIC METHODS
		*================================================================================================*/
        /*************************************************************************************************/

    } // CSVPasswordManager CLASS
} // PasswordVault NAMESPACE
